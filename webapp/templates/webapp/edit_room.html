{% extends 'webapp/base.html' %}

{% block title %}Editar Sala - Gestão de Salas{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h1 class="h3 mb-0"><i class="fas fa-edit me-2"></i>Editar Sala: {{ room.name }}</h1>
            </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                    </div>
                {% endif %}
                <form method="post" id="editRoomForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="name" class="form-label">Nome da Sala</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ room.name }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Horários Disponíveis</label>
                        <div id="scheduleContainer">
                            <!-- As linhas de horário serão inseridas aqui -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="addScheduleRow">
                            <i class="fas fa-plus me-2"></i>Adicionar Nova Linha de Horário
                        </button>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <a href="{% url 'webapp:room_list' %}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save me-2"></i>Atualizar Sala
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Template para as linhas de horário -->
<template id="scheduleRowTemplate">
    <div class="schedule-row border rounded p-3 mb-2 bg-light">
        <div class="row align-items-end">
            <div class="col-md-4">
                <label class="form-label">Dia da Semana</label>
                <select class="form-select day-select" required>
                    <option value="">Selecione...</option>
                    <option value="monday">Segunda-feira</option>
                    <option value="tuesday">Terça-feira</option>
                    <option value="wednesday">Quarta-feira</option>
                    <option value="thursday">Quinta-feira</option>
                    <option value="friday">Sexta-feira</option>
                    <option value="saturday">Sábado</option>
                    <option value="sunday">Domingo</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Horário Inicial</label>
                <input type="number" class="form-control start-time" min="0" max="23" placeholder="0-23" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Horário Final</label>
                <input type="number" class="form-control end-time" min="0" max="23" placeholder="0-23" required>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm remove-row">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>

{{ room.available_hours|json_script:"schedule-data" }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('addScheduleRow');
    const scheduleContainer = document.getElementById('scheduleContainer');
    const template = document.getElementById('scheduleRowTemplate');
    const form = document.getElementById('editRoomForm');
    
    // Dados da sala existente
    const existingSchedule = JSON.parse(document.getElementById('schedule-data').textContent);
    
    // Carregar horários existentes
    loadExistingSchedule();
    
    // Event listener para adicionar nova linha
    addButton.addEventListener('click', addScheduleRow);
    
    // Event listener para remover linhas
    scheduleContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-row')) {
            e.target.closest('.schedule-row').remove();
        }
    });
    
    // Event listener para validação de horários
    scheduleContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('start-time') || e.target.classList.contains('end-time')) {
            validateTimeRange(e.target.closest('.schedule-row'));
        }
    });
    
    // Event listener para validação de dias duplicados
    scheduleContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('day-select')) {
            validateDuplicateDays();
        }
    });
    
    // Event listener para submissão do formulário
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            // Converter dados para JSON e enviar
            const scheduleData = collectScheduleData();
            
            // Criar campo hidden com os dados JSON
            let hiddenField = document.getElementById('available_hours_json');
            if (!hiddenField) {
                hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = 'available_hours';
                hiddenField.id = 'available_hours_json';
                form.appendChild(hiddenField);
            }
            
            hiddenField.value = JSON.stringify(scheduleData);
            
            // Submeter o formulário
            form.submit();
        }
    });
    
    function loadExistingSchedule() {
        // Limpar container
        scheduleContainer.innerHTML = '';
        
        // Adicionar horários existentes
        Object.keys(existingSchedule).forEach(day => {
            existingSchedule[day].forEach(timeSlot => {
                addScheduleRowWithData(day, timeSlot.from, timeSlot.to);
            });
        });
        
        // Se não houver horários, adicionar uma linha vazia
        if (Object.keys(existingSchedule).length === 0) {
            addScheduleRow();
        }
    }
    
    function addScheduleRowWithData(day, startTime, endTime) {
        const clone = template.content.cloneNode(true);
        const row = clone.querySelector('.schedule-row');
        
        // Preencher os campos
        row.querySelector('.day-select').value = day;
        row.querySelector('.start-time').value = startTime;
        row.querySelector('.end-time').value = endTime;
        
        scheduleContainer.appendChild(clone);
    }
    
    function addScheduleRow() {
        const clone = template.content.cloneNode(true);
        scheduleContainer.appendChild(clone);
    }
    
    function validateTimeRange(row) {
        const startTime = parseInt(row.querySelector('.start-time').value);
        const endTime = parseInt(row.querySelector('.end-time').value);
        
        if (startTime >= endTime) {
            row.querySelector('.end-time').setCustomValidity('Horário final deve ser maior que o inicial');
        } else {
            row.querySelector('.end-time').setCustomValidity('');
        }
    }
    
    function validateDuplicateDays() {
        const selectedDays = Array.from(scheduleContainer.querySelectorAll('.day-select'))
            .map(select => select.value)
            .filter(day => day !== '');
        
        const duplicates = selectedDays.filter((day, index) => selectedDays.indexOf(day) !== index);
        
        if (duplicates.length > 0) {
            scheduleContainer.querySelectorAll('.day-select').forEach(select => {
                if (duplicates.includes(select.value)) {
                    select.setCustomValidity('Dia já selecionado');
                } else {
                    select.setCustomValidity('');
                }
            });
        } else {
            scheduleContainer.querySelectorAll('.day-select').forEach(select => {
                select.setCustomValidity('');
            });
        }
    }
    
    function validateForm() {
        const rows = scheduleContainer.querySelectorAll('.schedule-row');
        
        if (rows.length === 0) {
            alert('Adicione pelo menos um horário disponível.');
            return false;
        }
        
        // Validar se todos os campos estão preenchidos
        for (let row of rows) {
            const day = row.querySelector('.day-select').value;
            const startTime = row.querySelector('.start-time').value;
            const endTime = row.querySelector('.end-time').value;
            
            if (!day || !startTime || !endTime) {
                alert('Preencha todos os campos de horário.');
                return false;
            }
        }
        
        return true;
    }
    
    function collectScheduleData() {
        const scheduleData = {};
        const rows = scheduleContainer.querySelectorAll('.schedule-row');
        
        rows.forEach(row => {
            const day = row.querySelector('.day-select').value;
            const startTime = parseInt(row.querySelector('.start-time').value);
            const endTime = parseInt(row.querySelector('.end-time').value);
            
            if (day && !isNaN(startTime) && !isNaN(endTime)) {
                if (!scheduleData[day]) {
                    scheduleData[day] = [];
                }
                
                scheduleData[day].push({
                    from: startTime,
                    to: endTime
                });
            }
        });
        
        return scheduleData;
    }
});
</script>
{% endblock %}
